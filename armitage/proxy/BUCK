# armitage/proxy/BUCK
#
# Armitage Witness Proxy - Content-addressed caching HTTP proxy
#
# Witnesses all network fetches during builds:
#   - Logs URLs, timestamps, content hashes
#   - Caches content by SHA256
#   - Enforces domain allowlist
#
# Build: buck2 build //armitage/proxy:armitage-proxy
# Run:   PROXY_PORT=8080 ./result/bin/armitage-proxy

# Packages required by armitage-proxy
PROXY_PACKAGES = [
    "-package", "text",
    "-package", "aeson",
    "-package", "bytestring",
    "-package", "directory",
    "-package", "filepath",
    "-package", "network",
    "-package", "crypton",
    "-package", "memory",
    "-package", "time",
]

haskell_binary(
    name = "armitage-proxy",
    srcs = ["src/Main.hs"],
    main = "Main",
    compiler_flags = [
        "-O2",
        "-Wall",
        "-Wno-unused-imports",
        "-threaded",
        "-rtsopts",
        "-with-rtsopts=-N",
    ] + PROXY_PACKAGES,
    linker_flags = PROXY_PACKAGES,
    visibility = ["PUBLIC"],
)
