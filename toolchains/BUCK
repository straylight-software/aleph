# Toolchain definitions for aleph.build
#
# All tools come from Nix devshell with absolute Nix store paths.
# Paths are read from .buckconfig.local, generated by shellHook.
#
# Toolchains:
#   :cxx     - LLVM 22 C++ (host and device)
#   :nv      - NVIDIA device configuration
#   :haskell - GHC from Nix
#   :rust    - Rust from Nix
#   :lean    - Lean 4 prover
#   :python  - Python bootstrap

load(":cxx.bzl", "llvm_toolchain")
load(":nv.bzl", "nv_toolchain")
load(":haskell.bzl", "haskell_toolchain")
load(":rust.bzl", "rust_toolchain")
load(":lean.bzl", "lean_toolchain")
load(":execution.bzl", "lre_execution_platform", "host_configuration")
load(":shortlist.bzl", "shortlist_all")
load("@prelude//toolchains:python.bzl", "system_python_bootstrap_toolchain")
load("@prelude//toolchains:genrule.bzl", "system_genrule_toolchain")

# ════════════════════════════════════════════════════════════════════════════════
# C++ (LLVM 22)
# ════════════════════════════════════════════════════════════════════════════════
#
# Custom toolchain that reads paths from .buckconfig.local [cxx] section.
# Generates hermetic builds with absolute Nix store paths.
#
# Include paths (clang_resource_dir, gcc_include, etc.) are read from config
# and prepended to c_flags/cxx_flags automatically.
#
# One toolchain for host and device. Clang handles .cu files natively.
# No nvcc. No GCC wrappers.

llvm_toolchain(
    name = "cxx",
    # ════════════════════════════════════════════════════════════════════════
    # THE TURING REGISTRY — Non-negotiable build flags
    # ════════════════════════════════════════════════════════════════════════
    # Flags are read from .buckconfig.local [cxx.flags] section, which is
    # generated from nix/prelude/turing-registry.nix. Include paths are
    # also read from config and prepended automatically.
    #
    # Additional flags can be added here but should not override the
    # registry. Use c_extra_flags/cxx_extra_flags for project-specific needs.
    c_extra_flags = [
        "-std=c23",
        "-Wall",
        "-Wextra",
    ],
    cxx_extra_flags = [
        "-std=c++23",
        "-Wall",
        "-Wextra",
        "-fno-exceptions",  # We use Result types, not exceptions
    ],
    link_flags = [],  # -fuse-ld=lld added by llvm_toolchain
    link_style = "static",
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# NVIDIA (device configuration)
# ════════════════════════════════════════════════════════════════════════════════
#
# Target architectures and nvidia-sdk paths.
# Compilation uses :cxx toolchain (clang handles .cu natively).
# No nvcc. Ever.

nv_toolchain(
    name = "nv",
    nv_archs = [
        "sm_90",   # Hopper (H100) - minimum supported
        "sm_100",  # Blackwell (B100, B200)
        "sm_120",  # Blackwell (B200 full features)
    ],
    # nvidia-sdk paths, overridden by .buckconfig.local [nv] section
    nvidia_sdk_path = "/usr/local/cuda",
    nvidia_sdk_include = "/usr/local/cuda/include",
    nvidia_sdk_lib = "/usr/local/cuda/lib64",
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# HASKELL (stock GHC from Nix, no Mercury extensions)
# ════════════════════════════════════════════════════════════════════════════════
#
# bin/ghc wrapper filters Mercury flags. Workers disabled.

haskell_toolchain(
    name = "haskell",
    # ghcWithPackages provides packages via the default package env
    # Don't use -package-env=- as it disables all packages
    compiler_flags = [],
    visibility = ["PUBLIC"],
)

# NOTE: haskell_toolchain_library rules require a prelude that exports them.
# The straylight-buck2-prelude has these, but the stock prelude may not.
# Add them back when the prelude is updated.

# ════════════════════════════════════════════════════════════════════════════════
# RUST
# ════════════════════════════════════════════════════════════════════════════════
#
# Hermetic Rust toolchain with paths from .buckconfig.local [rust] section.
# Uses rustc, clippy, rustdoc from Nix store.

rust_toolchain(
    name = "rust",
    default_edition = "2021",
    rustc_flags = [
        "-C", "opt-level=2",
        "-C", "debuginfo=2",
    ],
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# LEAN 4
# ════════════════════════════════════════════════════════════════════════════════
#
# Lean 4 theorem prover / functional programming language.
# Paths from .buckconfig.local [lean] section.

lean_toolchain(
    name = "lean",
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# PYTHON BOOTSTRAP (required by Buck2 internals)
# ════════════════════════════════════════════════════════════════════════════════

system_python_bootstrap_toolchain(
    name = "python_bootstrap",
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# GENRULE (for custom build rules)
# ════════════════════════════════════════════════════════════════════════════════

system_genrule_toolchain(
    name = "genrule",
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# EXECUTION PLATFORMS
# ════════════════════════════════════════════════════════════════════════════════
#
# LRE (Local Remote Execution) - enables hybrid local/remote builds
# via NativeLink. Use: lre-start && buck2 build --prefer-remote //...

lre_execution_platform(
    name = "lre",
    cpu_configuration = host_configuration.cpu,
    os_configuration = host_configuration.os,
    local_enabled = True,
    remote_enabled = True,
    visibility = ["PUBLIC"],
)

# Local-only execution platform (default behavior)
lre_execution_platform(
    name = "local",
    cpu_configuration = host_configuration.cpu,
    os_configuration = host_configuration.os,
    local_enabled = True,
    remote_enabled = False,
    visibility = ["PUBLIC"],
)

# ════════════════════════════════════════════════════════════════════════════════
# SHORTLIST LIBRARIES
# ════════════════════════════════════════════════════════════════════════════════
#
# Prebuilt C++ libraries from the Nix shortlist module.
# Paths read from .buckconfig.local [shortlist] section.
#
# Available targets:
#   :zlib-ng       - High-performance zlib replacement
#   :fmt           - Modern C++ formatting library
#   :catch2        - C++ testing framework
#   :catch2-main   - Catch2 main() provider
#   :spdlog        - Fast C++ logging library
#   :libsodium     - Modern cryptography library
#   :mdspan        - C++23 multidimensional array view
#   :rapidjson     - Fast JSON parser/generator
#   :nlohmann-json - JSON for Modern C++

shortlist_all()
