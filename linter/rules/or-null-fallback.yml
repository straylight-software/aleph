id: or-null-fallback
language: nix
severity: warning
# Legitimate uses:
#   - prelude: implements Maybe-style safe accessors (get-attr, get-path, catAttrs)
ignores:
  - nix/prelude/**/*.nix
rule:
  kind: select_expression
  has:
    field: default
    kind: variable_expression
    has:
      kind: identifier
      regex: ^null$
message: "ALEPH-W004: defensive `or null` fallback"
note: |
  ## What's wrong?
  Using `x or null` as a fallback hides errors instead of failing fast.

  This pattern:
  - Silently propagates null through the codebase
  - Makes debugging harder (error surfaces far from cause)
  - Often indicates uncertainty about whether something exists

  ## What can I do to fix this?
  If the attribute must exist, remove the fallback and let it fail:

  ```nix
  # Bad: hides missing attribute
  pkgs.foo or null

  # Good: fails immediately if foo doesn't exist
  pkgs.foo
  ```

  If the attribute is genuinely optional, use explicit conditionals:

  ```nix
  # Good: explicit check with clear intent
  lib.optionalAttrs (pkgs ? foo) { inherit (pkgs) foo; }
  ```

  ## Exceptions
  - Prelude/lib code implementing Maybe-style functions
  - External package sets where attributes may not exist (e.g., haskell packages)
