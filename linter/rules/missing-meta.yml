id: missing-meta
language: nix
severity: error
rule:
  kind: apply_expression
  all:
    - any:
        - has:
            field: function
            kind: variable_expression
            has:
              kind: identifier
              regex: ^mkDerivation$
        - has:
            field: function
            kind: select_expression
            has:
              field: attrpath
              kind: attrpath
              has:
                kind: identifier
                regex: ^mkDerivation$
    - any:
        - has:
            field: argument
            kind: attrset_expression
            not:
              has:
                kind: binding_set
                any:
                  - has:
                      kind: binding
                      has:
                        field: attrpath
                        kind: attrpath
                        has:
                          kind: identifier
                          regex: ^meta$
                  - has:
                      kind: inherit
                      has:
                        field: attrs
                        kind: inherited_attrs
                        has:
                          kind: identifier
                          regex: ^meta$
        - has:
            field: argument
            kind: rec_attrset_expression
            not:
              has:
                kind: binding_set
                any:
                  - has:
                      kind: binding
                      has:
                        field: attrpath
                        kind: attrpath
                        has:
                          kind: identifier
                          regex: ^meta$
                  - has:
                      kind: inherit
                      has:
                        field: attrs
                        kind: inherited_attrs
                        has:
                          kind: identifier
                          regex: ^meta$
message: "ALEPH-W007: missing meta attribute"
note: |
  ## What's wrong?
  A derivation is missing a `meta` attribute.

  This is where external facing documentation
  about a given derivation lives. If you provide
  nothing it makes it harder for people to maintain
  and understand.

  ## What can I do to fix this?
  Add a `meta` attrset with at least a description.

  ```nix
  mkDerivation {
   meta = {
      homepage = "https://tailscale.com";
      description = "Node agent for Tailscale, a mesh VPN built on WireGuard";
      changelog = "https://tailscale.com/changelog#client";
      license = lib.licenses.bsd3;
      mainProgram = "tailscale";
      maintainers = with lib.maintainers; [
        mbaillie
        jk
        mfrw
        philiptaron
        pyrox0
        ryan4yin
      ];
    };
  };
  ```
