id: non-lisp-case
language: nix
severity: error
files:
  - "nix/**/*.nix"
ignores:
  # The prelude IS the translation layer - it necessarily uses external APIs
  - "nix/prelude/**"
  # flake-parts modules interface with flake-parts API (perSystem, mkPerSystemOption, etc.)
  # TODO: wrap flake-parts with a lisp-case prelude layer
  - "nix/modules/flake/**"
rule:
  kind: identifier
  regex: "^[a-z].*(_|[A-Z]).*"
  not:
    inside:
      any:
        # Allow in string interpolations (paths, commands)
        - kind: interpolation
        # Allow in inherit statements (tree-sitter-nix calls this inherited_attrs)
        - kind: inherited_attrs
        # Allow in attribute paths within select expressions (lib.optionalAttrs, prev.stdenv.mkDerivation)
        - kind: attrpath
          inside:
            kind: select_expression
message: "ALEPH-E003: non-lisp-case identifier"
note: |
  ## What's wrong?
  All identifiers must use lisp-case (kebab-case): `foo-bar`, not `fooBar` or `foo_bar`.

  This forces all code through the prelude, which provides well-typed paths.
  Direct nixpkgs/lib/builtins usage is forbidden.

  ## What can I do to fix this?
  Use the prelude equivalent:

  - `pkgs.stdenv.mkDerivation` → `prelude.mk-derivation`
  - `lib.optionalString` → `prelude.optional-string`
  - `buildInputs` → `build-inputs`

  See nix/prelude/ for available functions.
