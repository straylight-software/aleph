id: long-inline-string
language: nix
severity: warning
# Exclude infrastructure code where long inline scripts are legitimate:
# - prelude: doc comments are legitimately long
# - checks: test scripts and inline test source code
# - modules: flake modules with init scripts, configs
# - lib: utility functions with embedded scripts
# - overlays: package definitions often need inline patches/scripts
ignores:
  - nix/prelude/**/*.nix
  - nix/checks/**/*.nix
  - nix/modules/**/*.nix
  - nix/lib/**/*.nix
  - nix/overlays/**/*.nix
  - nix/_main.nix
rule:
  kind: indented_string_expression
  regex: "(?s)(?:.*\\n){12,}"
message: "WSN-W003: long inline string"
note: |
  ## What's wrong?
  A multi-line string exceeds 10 lines (nice try,
  that inline script isn't getting past me).

  Anything longer than 10 lines is likely to be a script
  in some other language. This is one of the most common sources
  of bugs in nix code, so we disallow it.

  ## What can I do to fix this?
  Consider moving the content to a file and loading it with `builtins.readFile`.

  If you need no interpolation:
  ```nix
  builtins.readFile ./my-file.sh
  ```

  If you variable interpolation:
  ```nix
  pkgs.replaceVars ./my-file.sh { x = "foo"; }
  ```
