id: no-heredoc-in-inline-bash
language: nix
severity: error
# Test scripts and build infrastructure often use heredocs legitimately
# - checks: test scripts create test files dynamically
# - lib: build utilities need to generate config files
# - modules: flake modules generate configuration
ignores:
  - nix/checks/**/*.nix
  - nix/lib/**/*.nix
  - nix/modules/**/*.nix
rule:
  kind: string_fragment
  regex: "(?s).*\\bcat\\b[^\\n]*<<-?.*"
  inside:
    kind: indented_string_expression
message: "WSN-E006: heredoc in inline bash string"
note: |
  ## What's wrong?
  Inline bash strings that use heredocs (e.g. `cat <<EOF`) are forbidden
  under punishment of death.

  Heredocs inside Nix strings are fragile and hard to lint safely, plus
  it's like crack to the bots for some reason and they always produce buggy
  heredocs in bash scripts.

  ## What can I do to fix this?
  Consider moving the content to a file and loading it with `builtins.readFile`.

  If you need no interpolation:
  ```nix
  builtins.readFile ./my-file.sh
  ```

  If you variable interpolation:
  ```nix
  pkgs.replaceVars ./my-file.sh { x = "foo"; }
  ```
