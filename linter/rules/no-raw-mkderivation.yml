id: no-raw-mkderivation
language: nix
severity: error
files:
  - "nix/**/*.nix"
ignores:
  # The prelude IS the boundary - it wraps nixpkgs
  - "nix/prelude/**"
  # flake-parts modules (TODO: wrap these too)
  - "nix/modules/flake/**"
rule:
  kind: select_expression
  pattern: $OBJ.mkDerivation
message: "ALEPH-E010: raw mkDerivation call"
note: |
  ## What's wrong?
  Direct `mkDerivation` calls bypass the typed prelude boundary.
  
  The prelude is the ONE PLACE that knows about nixpkgs internals.
  All other code must use the typed interface.
  
  ## What can I do to fix this?
  Use `prelude.mk-derivation` instead:
  
  ```nix
  # WRONG
  pkgs.stdenv.mkDerivation { ... }
  stdenv.mkDerivation { ... }
  
  # RIGHT  
  prelude.mk-derivation { ... }
  ```
  
  The prelude handles translation to nixpkgs internally.
  Your code stays clean and typed.
