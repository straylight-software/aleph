id: no-substitute-all
language: nix
severity: error
rule:
  kind: apply_expression
  any:
    # pkgs.substituteAll, final.substituteAll, etc.
    - has:
        field: function
        kind: select_expression
        has:
          field: attrpath
          kind: attrpath
          has:
            kind: identifier
            regex: ^(substituteAll|replaceVars|substitute)$
    # bare substituteAll (from `with pkgs;` or `inherit`)
    - has:
        field: function
        kind: variable_expression
        has:
          kind: identifier
          regex: ^(substituteAll|replaceVars|substitute)$
message: "ALEPH-E007: Text templating must use Dhall"
note: |
  ## What's wrong?
  `substituteAll`, `replaceVars`, and `substitute` are forbidden.
  All text generation must use Dhall templates.

  ## What should I use instead?
  Use `render.dhall-text` or `render.dhall-with-vars` from the prelude.

  ## Example

  Create a `.dhall` template:
  ```dhall
  let binPath : Text = env:BIN_PATH as Text
  let configDir : Text = env:CONFIG_DIR as Text
  in ''
  #!/usr/bin/env bash
  exec ${binPath}/my-program --config ${configDir}
  ''
  ```

  Use in Nix:
  ```nix
  configScript = render.dhall-with-vars "config-script" ./config.dhall {
    bin_path = lib.getBin myPackage;
    config_dir = "/etc/my-program";
  };
  ```

  ## No exceptions.
