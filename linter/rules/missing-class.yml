id: missing-class
language: nix
severity: error
files:
  - nix/modules/*/**/*.nix
ignores:
  - nix/modules/*/_index.nix
  - nix/modules/flake/options-schema.nix
  # Helper files (not module entry points)
  - nix/modules/**/options.nix
  - nix/modules/**/toolchains.nix
  - nix/modules/**/buckconfig.nix
  - nix/modules/**/shell-hook.nix
  - nix/modules/**/scripts/**/*.nix
  - nix/modules/**/nimi-init.nix
rule:
  kind: source_code
  not:
    regex: _class
message: "ALEPH-E004: missing `_class` attribute"
note: |
  ## What's wrong?
  Module files under `nix/modules/*/` must define `_class`.

  This helps:
  1. The reader tell instantly what type of module system
  this can be used in.
  2. Type checking which modules are compatible where.

  ## What can I do to fix this?
  Add `_class` to the module attrset, for example:

  ```nix
  {
    _class = "nixos";
    # ...
  }
  ```
