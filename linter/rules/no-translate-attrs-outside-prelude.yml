id: no-translate-attrs-outside-prelude
language: nix
severity: error
files:
  - "nix/**/*.nix"
ignores:
  # The prelude IS the translation boundary
  - "nix/prelude/**"
  # flake-parts modules (TODO: wrap these too)
  - "nix/modules/flake/**"
  # nvidia-sdk overlays use translate-attrs directly to avoid circular deps
  # with aleph.stdenv (which queries final.nvidia-sdk in toolchain.nix)
  - "nix/overlays/nvidia-sdk/**"
  - "nix/overlays/nixpkgs-nvidia-sdk.nix"
rule:
  any:
    # translate-attrs function call
    - kind: apply_expression
      has:
        field: function
        kind: variable_expression
        has:
          kind: identifier
          regex: ^translate-attrs$
    # inherit (translations) translate-attrs - importing it at all
    - kind: inherited_attrs
      has:
        kind: identifier
        regex: ^translate-attrs$
message: "ALEPH-E013: translate-attrs used outside prelude"
note: |
  ## What's wrong?
  `translate-attrs` is the prelude's internal translation layer.
  Using it directly means you're bypassing the typed interface.
  
  ## What can I do to fix this?
  Use `aleph.stdenv.default` or `prelude.mk-package` instead.
  These call `translate-attrs` internally.
  
  ```nix
  # WRONG - manual translation
  stdenv.mkDerivation (translate-attrs {
    native-build-inputs = [ cmake ];
  })
  
  # RIGHT - typed boundary handles translation
  aleph.stdenv.default {
    native-build-inputs = [ cmake ];
  }
  ```
  
  The stdenv functor accepts lisp-case attrs and translates them.
  You never call translate-attrs directly.
