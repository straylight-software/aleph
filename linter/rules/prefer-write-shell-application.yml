id: prefer-write-shell-application
language: nix
severity: error
rule:
  kind: apply_expression
  any:
    - has:
        field: function
        kind: select_expression
        has:
          field: attrpath
          kind: attrpath
          has:
            kind: identifier
          regex: ^(writeShellScript|writeShellScriptBin)$
    - has:
        field: function
        kind: variable_expression
        has:
          kind: identifier
          regex: ^(writeShellScript|writeShellScriptBin)$
message: "ALEPH-W006: prefer writeShellApplication"
note: |
  ## What's wrong?
  `writeShellScript` and `writeShellScriptBin` are deprecated in this codebase.

  `writeShellApplication` becomes the obvious choice when you consider:
  - It automatically sets `-euo pipefail`
  - It runs `shellcheck` on the generated script
  - It has `runtimeInputs` and `runtimeEnv` to avoid manual string interpolation

  ## What can I do to fix this?
  Use `writeShellApplication` instead:

  ```nix
  writeShellApplication {
    name = "my-wrapper";
    runtimeInputs = [ myHaskellScript ];
    text = ''
      exec my-haskell-script "$@"
    '';
  }
  ```
