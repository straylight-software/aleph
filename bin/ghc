              #!/usr/bin/env bash
              # Buck2 GHC wrapper - filters Mercury-specific flags for stock GHC
              filter_args() {
                  local skip_next=false
                  while IFS= read -r arg || [[ -n "$arg" ]]; do
                      if $skip_next; then skip_next=false; continue; fi
                      case "$arg" in
                          -dep-json) skip_next=true ;;
                          -fpackage-db-byte-code|-fprefer-byte-code|-fbyte-code-and-object-code|-hide-all-packages) ;;
                          *) echo "$arg" ;;
                      esac
                  done
              }
              final_args=()
              for arg in "$@"; do
                  if [[ "$arg" == @* ]]; then
                      response_file="${arg:1}"
                      if [[ -f "$response_file" ]]; then
                          filtered_file=$(mktemp)
                          filter_args < "$response_file" > "$filtered_file"
                          final_args+=("@$filtered_file")
                          trap "rm -f '$filtered_file'" EXIT
                      else
                          final_args+=("$arg")
                      fi
                  else
                      case "$arg" in
                          -dep-json|-fpackage-db-byte-code|-fprefer-byte-code|-fbyte-code-and-object-code|-hide-all-packages) ;;
                          *) final_args+=("$arg") ;;
                      esac
                  fi
              done
              exec ghc "${final_args[@]}"
              GHC_WRAPPER_EOF
                chmod +x bin/ghc

                cat > bin/ghc-pkg << 'EOF'
              #!/usr/bin/env bash
              exec ghc-pkg "$@"
              EOF
                chmod +x bin/ghc-pkg

                cat > bin/haddock << 'EOF'
              #!/usr/bin/env bash
              exec haddock "$@"
              EOF
                chmod +x bin/haddock

                # Generate hie.yaml for HLS (go-to-definition support)
                # Uses "direct" cradle - GHC with all packages from ghcWithPackages
                if [ ! -e "hie.yaml" ]; then
                  cat > hie.yaml << 'HIE_YAML_EOF'
# HLS configuration for Buck2 Haskell projects
# Generated by aleph.build module
#
# Uses a "direct" cradle - HLS invokes GHC directly with our ghcWithPackages.
# This provides go-to-definition for all packages in the Nix devshell.
#
# For per-file customization, use multi-cradle:
# https://haskell-language-server.readthedocs.io/en/latest/configuration.html

cradle:
  direct:
    arguments:
      - -Wall
      - -Wno-unused-imports
      # Source directories
      - -isrc/haskell
      - -isrc/tools/compdb
      - -isrc/tools/scripts
      - -isrc/examples/haskell
HIE_YAML_EOF
                  echo "Generated hie.yaml for HLS"
                fi


  cat > bin/lean << 'EOF'
#!/usr/bin/env bash
exec lean "$@"
EOF
  chmod +x bin/lean

  cat > bin/leanc << 'EOF'
#!/usr/bin/env bash
exec leanc "$@"
EOF
  chmod +x bin/leanc


  # C++ wrapper for FFI rules
  cat > bin/cxx << 'CXX_WRAPPER_EOF'
#!/usr/bin/env bash
set -euo pipefail
get_config() { grep "^${1} = " .buckconfig.local 2>/dev/null | cut -d'=' -f2 | tr -d ' '; }
CXX=$(get_config "cxx")
INCLUDE_ARGS=(
    "-resource-dir" "$(get_config clang_resource_dir)"
    "-isystem" "$(get_config gcc_include)"
    "-isystem" "$(get_config gcc_include_arch)"
    "-isystem" "$(get_config glibc_include)"
)
exec "$CXX" "${INCLUDE_ARGS[@]}" "$@"
CXX_WRAPPER_EOF
  chmod +x bin/cxx

  # compile_commands.json generator for clangd/clang-tidy
  cat > bin/compdb << 'COMPDB_EOF'
#!/usr/bin/env bash
# Generate compile_commands.json for clangd/clang-tidy
# Usage: compdb [targets...]
# If no targets, generates for all C++ targets in the project
set -euo pipefail

TARGETS="${@:-//...}"

echo "Generating compile_commands.json for: $TARGETS"
COMPDB_PATH=$(buck2 bxl prelude//cxx/tools/compilation_database.bxl:generate -- --targets $TARGETS 2>/dev/null | tail -1)

if [ -n "$COMPDB_PATH" ] && [ -f "$COMPDB_PATH" ]; then
  cp "$COMPDB_PATH" compile_commands.json
  echo "Generated compile_commands.json ($(jq length compile_commands.json) entries)"
else
  echo "Failed to generate compile_commands.json" >&2
  exit 1
fi
COMPDB_EOF
  chmod +x bin/compdb


echo "Generated bin/ wrappers for Buck2 toolchains"


# Shortlist hermetic C++ libraries
          # Add shortlist section to .buckconfig.local
          if [ -f ".buckconfig.local" ]; then
            if ! grep -q "\\[shortlist\\]" .buckconfig.local 2>/dev/null; then
              cat >> .buckconfig.local << 'SHORTLIST_EOF'

[shortlist]
# Hermetic C++ libraries
# Format: lib = /nix/store/..., lib_dev = /nix/store/...-dev (for headers)
zlib_ng = /nix/store/kmwphwsmk0ik37v4jbxq6say0sb2az1q-zlib-ng-2.2.5
fmt = /nix/store/s8x491axlnm309ppwpfr0yv19rivw33h-fmt-12.0.0
fmt_dev = /nix/store/xqhfjy7z1i43yx7zv00dxhwy7g5yaqrh-fmt-12.0.0-dev
catch2 = /nix/store/3dv40152ibwzvk4c1cxlj9fx2ms8dsw8-catch2-3.11.0
catch2_dev = /nix/store/3dv40152ibwzvk4c1cxlj9fx2ms8dsw8-catch2-3.11.0
spdlog = /nix/store/kqp0y77cn17sbxfk4p51m0z1zkryvj0l-spdlog-1.16.0
spdlog_dev = /nix/store/0m6yg5i5bvsq16vcyysm9m2z1y4hww0h-spdlog-1.16.0-dev
mdspan = /nix/store/15h676cngqhyxblg74lqr1cg58nqa8q3-mdspan-0.6.0
rapidjson = /nix/store/0k7lqs1am14y5amcqlbdxhnlk8hf2xpg-rapidjson-1.1.0-unstable-2025-02-05
nlohmann_json = /nix/store/sd346f4fszi73jg949y77r9hpdipsxa6-nlohmann_json-3.12.0
libsodium = /nix/store/n0jc1q20m3ar8q0vyi0mvz7cmvf0gwsh-libsodium-1.0.20
libsodium_dev = /nix/store/vijkvg4k07mlrb9446yz3pmqh2x62ixj-libsodium-1.0.20-dev

SHORTLIST_EOF
              echo "Added [shortlist] section to .buckconfig.local"
            fi
          fi


# Local Remote Execution (NativeLink)
# Append RE configuration to .buckconfig.local
# (build.nix shellHook creates .buckconfig.local, we append to it)
if [ -f ".buckconfig.local" ]; then
  # Check if RE config already present
  if ! grep -q "buck2_re_client" .buckconfig.local 2>/dev/null; then
    cat /nix/store/v9bgzrs6s2a7id7ppnqy6lqqdvs7z823-lre-buckconfig.ini >> .buckconfig.local
    echo "Appended NativeLink RE config to .buckconfig.local"
  fi
else
  echo "Warning: .buckconfig.local not found, LRE config not added"
fi



