# nix/modules/flake/build/buckconfig.nix
#
# .buckconfig.local generation
#
{
  lib,
  pkgs,
  cfg,
  toolchains,
}:
let
  inherit (toolchains)
    buck2-toolchain
    ghcForBuck2
    ghcVersion
    hsPackagesConfig
    ;

  scriptsDir = ./scripts;

  # Substitute placeholders in template files
  substitute =
    file: substitutions:
    let
      subst = lib.concatStringsSep " " (
        lib.mapAttrsToList (name: value: "--subst-var-by ${name} '${value}'") substitutions
      );
    in
    pkgs.runCommand (baseNameOf file) { } ''
      substitute ${file} $out ${subst}
    '';

  # ────────────────────────────────────────────────────────────────────────────
  # .buckconfig.local generator
  # ────────────────────────────────────────────────────────────────────────────
  buckconfig-local = pkgs.writeText "buckconfig.local" (
    lib.optionalString (cfg.toolchain.cxx.enable && buck2-toolchain ? cc) ''
      # AUTO-GENERATED by aleph.build module
      # DO NOT EDIT - regenerated on each shell entry

      [cxx]
      # Compilers (LLVM 22)
      cc = ${buck2-toolchain.cc}
      cxx = ${buck2-toolchain.cxx}
      cpp = ${buck2-toolchain.cpp}

      # Bintools
      ar = ${buck2-toolchain.ar}
      ld = ${buck2-toolchain.ld}

      # Include paths
      clang_resource_dir = ${buck2-toolchain.clang-resource-dir}
      gcc_include = ${buck2-toolchain.gcc-include}
      gcc_include_arch = ${buck2-toolchain.gcc-include-arch}
      glibc_include = ${buck2-toolchain.glibc-include}

      # Library paths
      gcc_lib = ${buck2-toolchain.gcc-lib}
      gcc_lib_base = ${buck2-toolchain.gcc-lib-base}
      glibc_lib = ${buck2-toolchain.glibc-lib}

      ${lib.optionalString (buck2-toolchain ? mdspan-include) ''
        # mdspan (Kokkos reference implementation)
        mdspan_include = ${buck2-toolchain.mdspan-include}
      ''}
    ''
    + lib.optionalString cfg.toolchain.haskell.enable ''

      [haskell]
      ghc = ${ghcForBuck2}/bin/ghc
      ghc_pkg = ${ghcForBuck2}/bin/ghc-pkg
      haddock = ${ghcForBuck2}/bin/haddock
      ghc_version = ${ghcVersion}
      ghc_lib_dir = ${ghcForBuck2}/lib/ghc-${ghcVersion}/lib
      global_package_db = ${ghcForBuck2}/lib/ghc-${ghcVersion}/lib/package.conf.d

      [haskell.packages]
      ${hsPackagesConfig}
    ''
    + lib.optionalString (cfg.toolchain.rust.enable && pkgs ? rustc) ''

      [rust]
      rustc = ${pkgs.rustc}/bin/rustc
      rustdoc = ${pkgs.rustc}/bin/rustdoc
      clippy_driver = ${pkgs.clippy}/bin/clippy-driver
      cargo = ${pkgs.cargo}/bin/cargo
      target_triple = x86_64-unknown-linux-gnu
    ''
    + lib.optionalString (cfg.toolchain.lean.enable && pkgs ? lean4) ''

      [lean]
      lean = ${pkgs.lean4}/bin/lean
      leanc = ${pkgs.lean4}/bin/leanc
      lake = ${pkgs.lean4}/bin/lake
      lean_lib_dir = ${pkgs.lean4}/lib/lean/library
      lean_include_dir = ${pkgs.lean4}/include
    ''
    + lib.optionalString (cfg.toolchain.python.enable && buck2-toolchain ? python-interpreter) ''

      [python]
      interpreter = ${buck2-toolchain.python-interpreter}
      python_include = ${buck2-toolchain.python-include}
      python_lib = ${buck2-toolchain.python-lib}
      nanobind_include = ${buck2-toolchain.nanobind-include}
      nanobind_cmake = ${buck2-toolchain.nanobind-cmake}
    ''
    + lib.optionalString (cfg.toolchain.nv.enable && buck2-toolchain ? nvidia-sdk-path) ''

      [nv]
      nvidia_sdk_path = ${buck2-toolchain.nvidia-sdk-path}
      nvidia_sdk_include = ${buck2-toolchain.nvidia-sdk-include}
      nvidia_sdk_lib = ${buck2-toolchain.nvidia-sdk-lib}
    ''
  );
in
{
  inherit buckconfig-local scriptsDir substitute;
}
