# src/tools/scripts/BUCK
#
# Aleph.Script CLI tools - typed Haskell scripts for container/VM/deploy ops.
#
# These use the Aleph.Script library for shell scripting ergonomics.
# Built with Buck2, dependencies from ghcWithPackages in Nix devshell.
#
# Uses haskell_script (from toolchains/haskell.bzl) instead of haskell_binary
# because the prelude's haskell_binary expects module names to match file paths,
# but single-file scripts use module Main.

load("@toolchains//:haskell.bzl", "haskell_script")

# Common compiler flags for all scripts
SCRIPT_FLAGS = [
    "-O2",
    "-Wall",
    "-Wno-unused-imports",
]

# External packages needed for linking (from ghcWithPackages)
# These are the deps of //src/haskell:aleph-script
SCRIPT_PACKAGES = [
    "text",
    "shelly",
    "foldl",
    "aeson",
    "dhall",
    "directory",
    "filepath",
    "bytestring",
    "megaparsec",
    "crypton",
    "memory",
    "unordered-containers",
    "vector",
    "unix",
    "async",
    "process",
    "containers",
    "transformers",
    "mtl",
    "time",
]

# List of all scripts (name derives from .hs file)
SCRIPTS = [
    # Crane (OCI image operations)
    "crane-inspect",
    "crane-pull",
    # Unshare (bwrap namespace runners)
    "unshare-run",
    "unshare-gpu",
    "fhs-run",
    "gpu-run",
    # Isospin (Firecracker fork) VM tools
    "isospin-run",
    "isospin-build",
    # Cloud Hypervisor VM tools
    "cloud-hypervisor-run",
    "cloud-hypervisor-gpu",
    # VFIO GPU passthrough
    "vfio-bind",
    "vfio-unbind",
    "vfio-list",
    # NativeLink remote execution tools
    "nativelink-deploy",
    "nativelink-local",
    # NVIDIA SDK extraction
    "nvidia-sdk",
    "nvidia-sdk-extract",
    # Archive utilities
    "combine-archive",
    # Lint tools (config file setup)
    "lint-init",
    "lint-link",
]

# Generate haskell_script targets for all scripts
[
    haskell_script(
        name = name,
        srcs = [name + ".hs"],
        include_paths = ["src/haskell"],
        compiler_flags = SCRIPT_FLAGS,
        packages = SCRIPT_PACKAGES,
    )
    for name in SCRIPTS
]
